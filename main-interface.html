<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Payment Planner ‚Äî Smart Splits & Savings</title>
<link rel="stylesheet" href="auth.css" />
<script defer src="auth.js"></script>
<script defer src="site-config.js"></script>
<style>
:root{
--bg:#eef6f8; --card:#ffffff; --muted:#64748b;
--accent:#0ea46e; --accent-2:#10B981; --border:#e6edf3; --warn:#f59e0b;
--danger:#b91c1c; --glass:rgba(255,255,255,0.6);
  }
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;color:#0f172a;background:linear-gradient(180deg,#f6fbfb 0%,var(--bg) 100%);padding:24px}
.container{max-width:1100px;margin:0 auto}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
h1{margin:0;font-size:20px}
.subtitle{color:var(--muted);font-size:13px}

.status-card{display:flex;gap:14px;align-items:flex-start;margin-bottom:14px;padding:14px;border-radius:12px;border:1px solid var(--border);box-shadow:0 8px 24px rgba(2,6,23,0.05);background:#fff}
.status-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;font-weight:800;font-size:12px;letter-spacing:0.2px}
.status-copy{font-size:13px;color:var(--muted);line-height:1.5}
.lockable{position:relative}
.lock-overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;padding:18px;text-align:center;background:rgba(255,255,255,0.85);backdrop-filter:blur(4px);border-radius:12px;border:1.5px dashed #fbbf24;z-index:6}
.lock-overlay .msg{font-weight:800;font-size:14px;color:#92400e;line-height:1.4}
.locked-blur{filter:blur(1px) saturate(0.8);pointer-events:none;user-select:none;opacity:0.65}
.toast-stack{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:1600}
.toast{padding:12px 14px;border-radius:10px;font-weight:700;font-size:13px;color:#0f172a;box-shadow:0 8px 22px rgba(2,6,23,0.12);background:#fff;border:1px solid var(--border);opacity:0.98}
.toast.success{border-color:#bbf7d0;background:#f0fdf4;color:#166534}
.toast.warn{border-color:#fde68a;background:#fffbeb;color:#92400e}
.toast.error{border-color:#fecdd3;background:#fef2f2;color:#991b1b}
.locked-field{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#f8fafc;margin-bottom:8px}
.locked-field .label{color:#475569;font-weight:700;font-size:13px;display:flex;align-items:center;gap:8px}
.locked-field .value{font-weight:900;font-size:15px;color:#0f172a}
.locked-chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#eef2ff;color:#312e81;font-weight:800;font-size:12px}
.locked-chip .lock{font-size:14px}
.muted-small{font-size:12px;color:#6b7280}

.layout{display:grid;grid-template-columns:1fr 380px;gap:18px}
@media (max-width:980px){ .layout{grid-template-columns:1fr} }

/* card */
.card{background:var(--card);padding:14px;border-radius:12px;border:1px solid var(--border);box-shadow:0 8px 30px rgba(2,6,23,0.04)}
.section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.muted{color:var(--muted);font-size:13px}

/* stepper */
.steps{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.step{padding:8px 10px;border-radius:10px;background:#f8fafc;border:1px solid var(--border);font-weight:600;font-size:13px;cursor:pointer}
.step.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none}

/* form rows */
.row{display:flex;gap:8px;align-items:center}
input[type=number],input[type=text],select{flex:1;padding:10px;border-radius:8px;border:1px solid var(--border);font-size:14px;background:#fff}
button{padding:9px 12px;border-radius:8px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700}
button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none}

.kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.kpi{flex:1;min-width:150px;background:#f7fffa;border:1px solid rgba(16,185,129,0.08);padding:10px;border-radius:10px}
.kpi .label{font-size:13px;color:var(--muted)}
.kpi .value{font-size:18px;font-weight:800;color:var(--accent);margin-top:6px}

.limits{margin-top:10px;font-size:13px}
.warn{background:#fff7ed;border:1px solid #fcd34d;padding:8px;border-radius:8px;color:var(--danger);font-size:13px}

/* lender list */
.lender{border-radius:10px;padding:10px;border:1px solid var(--border);background:#fff;margin-bottom:10px}
.lender .title{display:flex;justify-content:space-between;align-items:center;font-weight:700}
.small{font-size:13px;color:var(--muted)}

/* schedule table */
.table-wrap{overflow:auto;border-radius:8px;border:1px solid var(--border);margin-top:8px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:8px;border-bottom:1px solid #f2f6f8;text-align:right}
th:first-child,td:first-child{text-align:left}
thead th{background:#fff;position:sticky;top:0;font-weight:700;color:var(--muted)}

/* savings vault */
.vault{display:flex;flex-direction:column;gap:10px}
.vault-row{display:flex;gap:8px;align-items:center}
.vault-list{margin-top:8px}
.vault-item{padding:8px;border-radius:8px;border:1px solid var(--border);background:#fff;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}

/* vault polish */
.mini-kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.mini-kpi{flex:1;min-width:150px;background:#fff;border:1px solid var(--border);padding:10px;border-radius:10px;text-align:center;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
.mini-kpi .label{font-size:12px;color:var(--muted)}
.mini-kpi .value{font-size:16px;font-weight:800;color:var(--accent);margin-top:6px}
.chip{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,#ecfeff,#fff7ed);border:1px solid #e0f2fe;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;color:#0b7285}
.muted-tip{font-size:12px;color:var(--muted)}

footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}

/* small responsive tweaks */
@media (max-width:480px){
  .layout{grid-template-columns:1fr}
  .kpis{flex-direction:column}
}
</style>
</head>
<body>
<div class="toast-stack" id="toastStack" aria-live="polite" aria-atomic="true"></div>
<div class="container">
<header>
<div class="brand">
<div class="logo">EM</div>
<div>
<h1>Payment Planner & Savings Hub</h1>
<div class="subtitle">Smart payment splits ‚Ä¢ Partner guide ‚Ä¢ Quick verification ‚Ä¢ Savings Vault</div>
</div>
</div>
<div style="display:flex;align-items:center;gap:12px">
  <div class="muted">Fast ‚Ä¢ Digital ‚Ä¢ Informative</div>
  <div id="serverStatus" style="padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600;display:none">
    <span id="statusText">Server Status</span>
  </div>
  <div><button class="btn" onclick="openAdminReview()">Admin: Review KYC</button></div>
  <div><button class="btn" onclick="openEmailJsSetup()">EmailJS Setup</button></div>
</div>
</header>

<div class="card status-card" id="kycStatusCard">
  <div id="kycStatusBadge" class="status-badge" style="background:#f3f4f6;color:#111827">KYC ‚Ä¢ Not started</div>
  <div style="flex:1">
    <div id="kycStatusHeadline" style="font-weight:800;color:#0f172a;margin-bottom:4px;font-size:14px">KYC required before loan access</div>
    <div id="kycStatusCopy" class="status-copy">Complete KYC to unlock loan schedules, EMI planner, and credit insights. We show everything upfront but keep sensitive actions locked until verification.</div>
  </div>
  <div style="display:flex;flex-direction:column;gap:8px">
    <button class="btn primary" onclick="openKycPortal()">Start / Update KYC</button>
    <button class="btn" onclick="refreshKycStatusUI(true)">Refresh status</button>
  </div>
</div>

<div class="card" id="creditProfileCard" style="margin-bottom:12px;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px">
    <div>
      <div style="font-weight:900;font-size:16px;color:#0f172a;display:flex;align-items:center;gap:8px">Credit & Payment Profile <span class="locked-chip" title="This data is verified and cannot be modified by the user."><span class="lock">üîí</span> Automatically set after KYC verification</span></div>
      <div class="muted-small" id="creditProfileHint">Will auto-fill after KYC is verified.</div>
    </div>
  </div>
  <div id="creditProfileFields">
    <div class="locked-field" title="This data is verified and cannot be modified by the user.">
      <div class="label">üîí Credit Score</div>
      <div class="value" id="creditScoreVal">‚Äî</div>
    </div>
    <div class="locked-field" title="This data is verified and cannot be modified by the user.">
      <div class="label">üîí Loan Eligibility</div>
      <div class="value" id="loanEligibilityVal">‚Äî</div>
    </div>
    <div class="locked-field" title="This data is verified and cannot be modified by the user.">
      <div class="label">üîí EMI Limit</div>
      <div class="value" id="emiLimitVal">‚Äî</div>
    </div>
    <div class="locked-field" title="This data is verified and cannot be modified by the user.">
      <div class="label">üîí Linked Bank</div>
      <div class="value" id="bankLinkedVal">‚Äî</div>
    </div>
  </div>
</div>

<!-- stepper -->
<div class="card" style="margin-bottom:12px">
<div class="steps" id="steps">
<div class="step active" data-step="1">1 ‚Ä¢ Payment Details</div>
<div class="step" data-step="2">2 ‚Ä¢ Partners & Verification</div>
<div class="step" data-step="3">3 ‚Ä¢ Schedule & Confirm</div>
<div class="step" data-step="4">4 ‚Ä¢ Savings Vault</div>
</div>
<div class="muted">Navigate steps ‚Äî enter details, check lenders, view schedule, and save money.</div>
</div>

<div class="layout">
<!-- left: main flow -->
<div>
<!-- STEP 1: EMI form -->
<div class="card" id="step-1">
<div class="section-title"><strong>Payment Setup</strong><div class="small">Based on your profile, rate fixed at <strong style="color:var(--accent)">6% p.a.</strong></div></div>
<div style="display:flex;gap:12px;flex-wrap:wrap">
<div style="flex:1;min-width:260px">
<label class="small">Credit Score (300‚Äì900)</label>
<div class="row" style="margin-bottom:8px">
<input id="cibil" type="number" min="300" max="900" value="750">
<button class="quick" onclick="setScore(800)">Quick 800</button>
</div>

<label class="small">Amount needed (‚Çπ)</label>
<div class="row" style="margin-bottom:8px">
<input id="loanAmt" type="number" min="0" value="200000">
<button class="quick" onclick="setLoan(50000)">‚Çπ50k</button>
<button class="quick" onclick="setLoan(200000)">‚Çπ2L</button>
</div>

<label class="small">Tenure (months)</label>
<div class="row" style="margin-bottom:8px">
<input id="months" type="number" min="1" value="60">
<button class="quick" onclick="setTenure(12)">12</button>
<button class="quick" onclick="setTenure(60)">60</button>
</div>

<label class="small">Interest rate</label>
<div class="row" style="margin-bottom:6px">
<input id="rateFixed" type="text" disabled value="6% (fixed)">
<div class="small" style="min-width:140px">Fixed for all borrowers</div>
</div>

<div style="margin-top:8px;display:flex;gap:8px">
<button class="primary" onclick="goStep(2)">Check partners & verify ‚Üí</button>
<button onclick="goStep(3)">View schedule ‚Üí</button>
</div>
</div>

<div style="width:320px">
<div class="kpis">
<div class="kpi"><div class="label">Monthly Payment</div><div id="emiVal" class="value">‚Çπ0</div></div>
<div class="kpi"><div class="label">Total Payment</div><div id="totalVal" class="value">‚Çπ0</div></div>
<div class="kpi"><div class="label">Total Interest</div><div id="intVal" class="value">‚Çπ0</div></div>
</div>

<div class="limits">
<div class="small" style="margin-top:8px">Allowed: <span id="allowedBand">‚Äî</span></div>
<div class="small" id="allowedLoanTxt"></div>
<div class="small" id="allowedTenureTxt"></div>
<div class="small" id="tenureCompareTxt" style="margin-top:6px"></div>
<div id="clampMsg" style="margin-top:8px"></div>
</div>
</div>
</div>
</div>

<!-- STEP 2: Lenders & KYC -->
<div class="card" id="step-2" style="display:none;margin-top:12px">
<div class="section-title"><strong>Payment Partners & Verification</strong><div class="small">How partners help you split payments, rates, and quick verification</div></div>

<div class="lender">
<div class="title"><div>Banks (SBI, HDFC, ICICI, Axis)</div><div class="small">Public & Private</div></div>
<div class="small" style="margin-top:6px">
              Offer secure payment plans (home, auto, personal). Rates: typically 9‚Äì15% for good profiles on secured plans; personal plans may vary. Processes include branch/app application, quick verification, statement review, credit check, and fast approval for qualified customers.
</div>
</div>

<div class="lender">
<div class="title"><div>NBFCs (Bajaj Finance, Tata Capital, L&T Finance)</div><div class="small">Flexible & fast</div></div>
<div class="small" style="margin-top:6px">
              NBFCs provide quicker disbursals and flexible eligibility; interest often ~11%‚Äì24% depending on risk. They use digital tools and alternative data to evaluate borrowers.
</div>
</div>

<div class="lender">
<div class="title"><div>Fintechs (Slice, EarlySalary, Moneyview)</div><div class="small">App-first</div></div>
<div class="small" style="margin-top:6px">
              Fintechs offer instant decisions, app-based e-KYC (Aadhaar OTP / Video KYC), and alternative data underwriting. Typical APR: ~10.99%‚Äì24%+. Fees and late charges are explained in the Key Facts Statement at offer time.
</div>
</div>

<div class="section-title" style="margin-top:6px"><strong>KYC & Documents</strong><div class="small">What lenders usually ask for</div></div>
<div class="small" style="margin-bottom:8px">
<strong>Identity:</strong> PAN, Aadhaar, Passport, Driving License<br>
<strong>Address:</strong> Aadhaar, utility bills, passport, rent agreement<br>
<strong>Income:</strong> Salaried ‚Äî last 3 months salary slips & bank statements; Self-employed ‚Äî ITR (2‚Äì3 years), audited financials, bank statements, GST/Udyam for businesses<br>
<strong>Verification:</strong> e-KYC (Aadhaar OTP) or Video KYC; field verification for certain loans; CIBIL hard inquiry; bank statement analysis for income validation.
</div>


<div class="section-title" style="margin-top:6px"><strong>Slice ‚Äî Example (detailed)</strong><div class="small">Digital-first SFB (app-based)</div></div>
<div class="small">
<strong>How Slice works:</strong> App registration ‚Üí mobile OTP ‚Üí e-KYC (Aadhaar/PAN) ‚Üí link bank via account aggregator ‚Üí ML-based credit decision ‚Üí instant credit limit / purchase power. Offers no-cost EMI for short splits, EMI conversion for purchases, and term loans. Typical APR varies by profile (approx 10.99%‚Äì24%+). As a bank (SFB) it accepts deposits and offers lower cost of funds compared to NBFCs.
</div>

<div style="margin-top:10px" class="row">
<button onclick="goStep(1)">‚Üê Back</button>
<button class="primary" onclick="goStep(3)">Proceed to Schedule & Confirm ‚Üí</button>
</div>
</div>

<!-- STEP 3: Schedule & Confirm -->
<!-- ===== Compact Schedule & Confirm (friendly) ===== -->
<section id="schedule-confirm" class="lockable" style="margin-top:18px; display:grid; grid-template-columns: 1fr 320px; gap:16px; align-items:start;">
<div id="loanLockOverlay" class="lock-overlay" aria-hidden="true"><div class="msg">üîí KYC required before viewing full loan schedule and repayment details.</div></div>
<!-- Left: compact summary + preview -->
<div>
<div class="card" style="padding:16px;">
<!-- Step pills (compact) -->
<div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;align-items:center">
<div style="background:#fff;border-radius:12px;padding:8px 12px;border:1px solid var(--border);font-weight:700">1 ‚Ä¢ Loan Details</div>
<div style="background:#fff;border-radius:12px;padding:8px 12px;border:1px solid var(--border);font-weight:700">2 ‚Ä¢ Lenders & KYC</div>
<div style="background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;border-radius:12px;padding:8px 12px;font-weight:800">3 ‚Ä¢ Schedule</div>
<div style="background:#fff;border-radius:12px;padding:8px 12px;border:1px solid var(--border);font-weight:700">4 ‚Ä¢ Savings Vault</div>
</div>

<div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px">
<div>
<h3 style="margin:0 0 6px;font-size:18px">Amortization ‚Äî Quick view</h3>
<div class="small" style="color:var(--muted)">Friendly summary ‚Äî expand for full schedule</div>
</div>

<div style="display:flex;gap:8px;align-items:center">
<button class="btn" id="toggleFullBtn">View full schedule</button>
</div>
</div>

<!-- compact KPIs -->
<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">
<div style="flex:1;min-width:140px;padding:10px;border-radius:10px;border:1px solid var(--border);background:#fff;text-align:center">
<div class="small">Monthly EMI</div>
<div id="c-kpi-emi" style="font-weight:900;color:var(--accent);font-size:18px;margin-top:6px">‚Äî</div>
</div>
<div style="flex:1;min-width:140px;padding:10px;border-radius:10px;border:1px solid var(--border);background:#fff;text-align:center">
<div class="small">Total Interest</div>
<div id="c-kpi-interest" style="font-weight:900;color:#0b7285;font-size:16px;margin-top:6px">‚Äî</div>
</div>
<div style="flex:1;min-width:140px;padding:10px;border-radius:10px;border:1px solid var(--border);background:#fff;text-align:center">
<div class="small">Total Pay</div>
<div id="c-kpi-total" style="font-weight:900;color:#0f172a;font-size:16px;margin-top:6px">‚Äî</div>
</div>
</div>

<!-- tiny preview table (first 3 rows) -->
<div style="overflow:auto;border-radius:10px;border:1px solid var(--border);background:#fff;margin-bottom:10px">
<table id="previewTable" style="width:100%;border-collapse:collapse;min-width:440px">
<thead>
<tr>
<th style="text-align:left;padding:10px;border-bottom:1px solid var(--border);width:40px">#</th>
<th style="text-align:left;padding:10px;border-bottom:1px solid var(--border)">Payment</th>
<th style="text-align:right;padding:10px;border-bottom:1px solid var(--border)">Principal</th>
<th style="text-align:right;padding:10px;border-bottom:1px solid var(--border)">Interest</th>
</tr>
</thead>
<tbody id="previewBody">
<!-- JS will insert 3 preview rows -->
</tbody>
</table>
</div>

<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
<button class="btn primary" id="confirmLoanBtnCompact" onclick="alert('Loan confirmed (demo).')">Confirm Loan</button>
<button class="btn" onclick="goToVault()">Go to Savings Vault ‚Üí</button>
<div class="small" style="color:var(--muted)">Tip: Expand to download or print full schedule.</div>
</div>
</div>

<!-- Collapsible full schedule (hidden by default) -->
<div id="fullScheduleWrap" style="display:none;margin-top:12px">
<div class="card" style="padding:14px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
<strong>Full Amortization Schedule</strong>
<div style="display:flex;gap:8px">
<button class="btn" id="downloadCsvBtn">Download CSV</button>
<button class="btn" id="printScheduleBtn">Print</button>
<button class="btn" id="collapseFullBtn">Close</button>
</div>
</div>

<div style="overflow:auto;border-radius:10px;border:1px solid var(--border);background:#fff">
<table id="fullAmortTable" style="width:100%;border-collapse:collapse;min-width:760px">
<thead style="background:#fff">
<tr>
<th style="text-align:left;padding:10px;border-bottom:1px solid var(--border);width:60px">#</th>
<th style="text-align:left;padding:10px;border-bottom:1px solid var(--border)">Payment</th>
<th style="text-align:right;padding:10px;border-bottom:1px solid var(--border)">Principal</th>
<th style="text-align:right;padding:10px;border-bottom:1px solid var(--border)">Interest</th>
<th style="text-align:right;padding:10px;border-bottom:1px solid var(--border)">Balance</th>
</tr>
</thead>
<tbody id="fullBody"></tbody>
<tfoot>
<tr>
<td colspan="2" style="padding:10px;border-top:1px solid var(--border);font-weight:800">Totals</td>
<td id="f-sum-principal" style="text-align:right;padding:10px;border-top:1px solid var(--border);font-weight:800">‚Äî</td>
<td id="f-sum-interest" style="text-align:right;padding:10px;border-top:1px solid var(--border);font-weight:800">‚Äî</td>
<td style="text-align:right;padding:10px;border-top:1px solid var(--border)"></td>
</tr>
</tfoot>
</table>
</div>
</div>
</div>
</div>

<!-- Right column: quick actions (unchanged, compact) -->
<aside style="display:flex;flex-direction:column;gap:12px;">
<div class="card" style="padding:14px;">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<strong>Quick Actions</strong>
<div class="small">One-click</div>
</div>

<div style="display:flex;flex-direction:column;gap:8px">
<button class="btn" onclick="setDemoCibil(750)">Set CIBIL 750 (Excellent)</button>
<button class="btn" onclick="setDemoLoan(100000)">Set Loan ‚Çπ1L</button>
<button class="btn" onclick="setDemoTenure(24)">Set Tenure 24m</button>
<button class="btn" onclick="document.getElementById('loan-entry')?.scrollIntoView({behavior:'smooth'})">Go to Loan Entry</button>
</div>
</div>

<div class="card" style="padding:14px;">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<strong>At a glance</strong>
<div class="small">Info</div>
</div>
<div class="small" style="margin-bottom:8px;line-height:1.5">
        ‚Ä¢ Reducing-balance EMIs.<br>
        ‚Ä¢ Lenders check CIBIL & bank statements.
</div>
<div style="display:flex;justify-content:space-between;align-items:center">
<div class="small">Fixed rate</div>
<div style="font-weight:900;color:var(--accent)">6% p.a.</div>
</div>
</div>
</aside>
</section>

<script>
/* Compact schedule logic:
 - show KPIs + 3-row preview by default
 - expand shows full schedule, CSV & Print
 - respects localStorage keys (loan_principal, loan_tenure, loan_rate) if set
*/

// number formatter
function fmtINR(n){
if(isNaN(n)) return '‚Äî';
return '‚Çπ' + Number(Math.round(n)).toLocaleString('en-IN');
}

// build schedule (same reducing-balance EMI calc)
function buildSchedule(P, nMonths, annualRate){
const r = annualRate/100/12;
const emi = (r === 0) ? P / nMonths : (P * r * Math.pow(1+r,nMonths))/(Math.pow(1+r,nMonths)-1);
let bal = P;
const rows = [];
let sumPrincipal = 0, sumInterest = 0;
for(let i=1;i<=nMonths;i++){
const interest = bal * r;
const principal = Math.min(emi - interest, bal);
bal = Math.max(bal - principal, 0);
rows.push({i, payment: emi, principal, interest, balance: bal});
sumPrincipal += principal; sumInterest += interest;
  }
return {rows, emi, sumPrincipal, sumInterest, totalPay: emi * nMonths};
}

// read params or defaults
function getLoanParams(){
const p = Number(localStorage.getItem('loan_principal')) || Number(localStorage.getItem('last_principal')) || 100000;
const n = Number(localStorage.getItem('loan_tenure')) || Number(localStorage.getItem('last_tenure')) || 24;
const r = Number(localStorage.getItem('loan_rate')) || 6;
return {P:p, nMonths:n, rate:r};
}

function renderCompact(){
const params = getLoanParams();
const schedule = buildSchedule(params.P, params.nMonths, params.rate);

// KPIs
document.getElementById('c-kpi-emi').textContent = fmtINR(schedule.emi);
document.getElementById('c-kpi-interest').textContent = fmtINR(schedule.sumInterest);
document.getElementById('c-kpi-total').textContent = fmtINR(schedule.totalPay);

// preview: first 3 rows
const previewBody = document.getElementById('previewBody');
previewBody.innerHTML = '';
const previewRows = schedule.rows.slice(0,3);
previewRows.forEach(r=>{
const tr = document.createElement('tr');
tr.innerHTML = `
      <td style="padding:8px;border-bottom:1px solid var(--border)">${r.i}</td>
      <td style="padding:8px;border-bottom:1px solid var(--border)">${fmtINR(r.payment)}</td>
      <td style="padding:8px;border-bottom:1px solid var(--border);text-align:right">${fmtINR(r.principal)}</td>
      <td style="padding:8px;border-bottom:1px solid var(--border);text-align:right">${fmtINR(r.interest)}</td>
    `;
previewBody.appendChild(tr);
  });

// prepare full data for later
window.__compactFullSchedule = schedule;
}

// expand to full schedule
function expandFull(){
const wrap = document.getElementById('fullScheduleWrap');
const fullBody = document.getElementById('fullBody');
const schedule = window.__compactFullSchedule || buildSchedule(100000,24,6);
fullBody.innerHTML = '';
schedule.rows.forEach(r=>{
const tr = document.createElement('tr');
tr.innerHTML = `
      <td style="padding:8px;border-bottom:1px solid var(--border)">${r.i}</td>
      <td style="padding:8px;border-bottom:1px solid var(--border)">${fmtINR(r.payment)}</td>
      <td style="padding:8px;border-bottom:1px solid var(--border);text-align:right">${fmtINR(r.principal)}</td>
      <td style="padding:8px;border-bottom:1px solid var(--border);text-align:right">${fmtINR(r.interest)}</td>
      <td style="padding:8px;border-bottom:1px solid var(--border);text-align:right">${fmtINR(r.balance)}</td>
    `;
fullBody.appendChild(tr);
  });

document.getElementById('f-sum-principal').textContent = fmtINR(schedule.sumPrincipal);
document.getElementById('f-sum-interest').textContent = fmtINR(schedule.sumInterest);

wrap.style.display = 'block';
wrap.scrollIntoView({behavior:'smooth', block:'nearest'});
}

// CSV download for full
function downloadCSV(){
const schedule = window.__compactFullSchedule || buildSchedule(100000,24,6);
let csv = 'No.,Payment,Principal,Interest,Balance\n';
schedule.rows.forEach(r => {
csv += `${r.i},${r.payment.toFixed(2)},${r.principal.toFixed(2)},${r.interest.toFixed(2)},${r.balance.toFixed(2)}\n`;
  });
const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
const url = URL.createObjectURL(blob);
const a = document.createElement('a'); a.href = url; a.download = 'amortization.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function printSchedule(){
const tableHtml = document.getElementById('fullAmortTable').outerHTML;
const win = window.open('', '_blank');
win.document.write('<title>Amortization Schedule</title><style>body{font-family:Arial;padding:20px}table{width:100%;border-collapse:collapse}td,th{padding:8px;border:1px solid #ddd}</style><h2>Amortization Schedule</h2>' + tableHtml);
win.document.close();
win.print();
}

// demo quick sets (same as before)
function setDemoCibil(score){ localStorage.setItem('demo_cibil', String(score)); alert('CIBIL set to ' + score + ' (demo).'); }
function setDemoLoan(amount){ localStorage.setItem('loan_principal', String(amount)); renderCompact(); updateLoanPreview(); alert('Loan set to ‚Çπ' + Number(amount).toLocaleString('en-IN')); }
function setDemoTenure(m){ localStorage.setItem('loan_tenure', String(m)); renderCompact(); updateLoanPreview(); alert('Tenure set to ' + m + ' months'); }

// wire up buttons
document.getElementById('toggleFullBtn').addEventListener('click', () => expandFull());
document.getElementById('collapseFullBtn').addEventListener('click', () => { document.getElementById('fullScheduleWrap').style.display = 'none'; document.getElementById('toggleFullBtn').textContent = 'View full schedule'; });
document.getElementById('downloadCsvBtn').addEventListener('click', downloadCSV);
document.getElementById('printScheduleBtn').addEventListener('click', printSchedule);

// initial render
renderCompact();
</script>

<!-- STEP 4: Savings Vault -->
<!-- ===== Savings Vault (Add-to-Cart style) ===== -->
<section id="vault" class="lockable" style="margin-top:16px; display:grid; grid-template-columns: 1fr 360px; gap:16px; align-items:start;">
  <div id="vaultLockOverlay" class="lock-overlay" aria-hidden="true"><div class="msg">üîí Savings vault unlocks after KYC verification.</div></div>
<!-- Left: goal creation & catalog -->
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center">
<strong>Savings Vault ‚Äî Build your goals</strong>
<div class="small">Add goals like items to a cart</div>
</div>

<div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
  <div class="chip">Suggestion: Save <span id="suggestedMonthly">‚Çπ‚Äî</span> / month (‚âà 10% of EMI)</div>
  <div class="muted-tip">Secure, flexible, and saved locally ‚Äî edit anytime.</div>
</div>

<div style="margin-top:12px;display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
<!-- Create new goal -->
<div style="flex:1;min-width:260px;">
<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
<input id="goalName" placeholder="Goal name (Emergency / Travel)" style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--border)">
</div>
<div style="display:flex;gap:8px;margin-bottom:8px">
<input id="goalMonthly" type="number" min="0" placeholder="Monthly ‚Çπ" style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--border)">
<input id="goalMonths" type="number" min="1" placeholder="Months" style="width:100px;padding:10px;border-radius:10px;border:1px solid var(--border)">
</div>
<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
<input id="goalRate" type="number" min="0" step="0.1" placeholder="Interest % p.a." style="width:140px;padding:10px;border-radius:10px;border:1px solid var(--border)">
<button class="btn primary" id="previewGoalBtn">Preview</button>
</div>

<div id="goalPreview" style="padding:10px;border-radius:10px;border:1px dashed var(--border);background:#fff;display:none">
<div style="font-weight:800" id="previewTitle"></div>
<div class="small" id="previewSummary" style="margin-top:6px"></div>
<div style="margin-top:8px">
<button class="btn" id="addToVaultBtn">Add to Vault</button>
</div>
</div>
</div>

<!-- Quick presets (collapsible) -->
<div style="width:220px">
  <details open>
    <summary style="font-weight:800;cursor:pointer">Quick presets</summary>
    <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
      <button class="btn" onclick="fillPreset('Emergency Fund',2000,12,6)">Emergency ‚Çπ2,000 √ó12</button>
      <button class="btn" onclick="fillPreset('Travel',3500,8,5.5)">Travel ‚Çπ3,500 √ó8</button>
      <button class="btn" onclick="fillPreset('Gadget',1500,6,4)">Gadget ‚Çπ1,500 √ó6</button>
    </div>
  </details>
</div>
</div>

<!-- Catalog: saved vault goals (preview) -->
<div style="margin-top:14px">
<strong>Your Vault (preview)</strong>
<div id="vaultCatalog" style="margin-top:8px;display:grid;gap:8px"></div>
</div>
</div>

<!-- Right: cart -->
<aside class="card" style="padding:14px;">
<div style="display:flex;justify-content:space-between;align-items:center">
<strong>Vault Cart</strong>
<div class="small">Saved locally</div>
</div>

<!-- Insights strip -->
<div class="mini-kpis">
  <div class="mini-kpi"><div class="label">Goals</div><div class="value" id="insightGoals">0</div></div>
  <div class="mini-kpi"><div class="label">Monthly total</div><div class="value" id="insightMonthly">‚Çπ0</div></div>
  <div class="mini-kpi"><div class="label">Projected target</div><div class="value" id="insightTarget">‚Çπ0</div></div>
  </div>

<div id="cartItems" style="margin-top:12px;display:flex;flex-direction:column;gap:8px;min-height:120px">
<!-- cart rows inserted here -->
</div>

<div style="margin-top:12px;border-top:1px dashed var(--border);padding-top:12px;display:flex;flex-direction:column;gap:8px">
<div style="display:flex;justify-content:space-between">
<div class="small">Monthly total</div>
<div id="cartMonthly" style="font-weight:800">‚Çπ0</div>
</div>
<div style="display:flex;justify-content:space-between">
<div class="small">Combined target</div>
<div id="cartTarget" style="font-weight:800">‚Çπ0</div>
</div>

<div style="display:flex;gap:8px;margin-top:6px">
<button class="btn primary" id="saveVaultBtn">Save Vault</button>
<button class="btn" id="clearVaultBtn">Clear</button>
</div>

<div class="small" style="margin-top:8px;color:var(--muted)">Saved vaults are stored in your browser. For accounts, we can move this to user storage later.</div>
</div>
</aside>
</section>

<script>
/* Savings Vault ‚Äî add-to-cart behavior
  - Goals are objects: {id, name, monthly, months, rate, target}
  - target = future value of monthly series using monthly compounding at given annual rate
  - persisted in localStorage under key 'vault_cart'
*/

// helpers
function fvSeries(monthly, months, annualRate){
const r = annualRate/100/12;
if(r === 0) return monthly * months;
return monthly * ((Math.pow(1+r, months) - 1) / r);
}
function fmtINR(n){ return '‚Çπ' + Number(Math.round(n)).toLocaleString('en-IN'); }
function uid(){ return 'v_' + Math.random().toString(36).slice(2,9); }

// DOM
const previewBox = document.getElementById('goalPreview');
const previewTitle = document.getElementById('previewTitle');
const previewSummary = document.getElementById('previewSummary');
const vaultCatalog = document.getElementById('vaultCatalog');
const cartItemsEl = document.getElementById('cartItems');
const cartMonthlyEl = document.getElementById('cartMonthly');
const cartTargetEl = document.getElementById('cartTarget');

let cart = JSON.parse(localStorage.getItem('vault_cart') || '[]');

// fill presets
function fillPreset(name, monthly, months, rate){
document.getElementById('goalName').value = name;
document.getElementById('goalMonthly').value = monthly;
document.getElementById('goalMonths').value = months;
document.getElementById('goalRate').value = rate;
document.getElementById('previewGoalBtn').click();
}

// preview button
document.getElementById('previewGoalBtn').addEventListener('click', ()=>{
const name = (document.getElementById('goalName').value || 'Untitled Goal').trim();
const monthly = Number(document.getElementById('goalMonthly').value) || 0;
const months = Number(document.getElementById('goalMonths').value) || 1;
const rate = Number(document.getElementById('goalRate').value || 6);
const target = fvSeries(monthly, months, rate);
previewTitle.textContent = name;
previewSummary.textContent = `${fmtINR(monthly)} / month ‚Ä¢ ${months} months ‚Ä¢ ${rate}% p.a. ‚Üí Target ‚âà ${fmtINR(target)}`;
previewBox.style.display = 'block';
// attach Add to Vault
document.getElementById('addToVaultBtn').onclick = () => {
addToCart({name, monthly, months, rate, target});
previewBox.style.display = 'none';
// clear inputs lightly
// document.getElementById('goalName').value = '';
  };
});

// add to cart
function addToCart(goal){
goal.id = uid();
cart.push(goal);
saveCart();
renderCart();
renderCatalog();
// small success feedback
const el = document.createElement('div'); el.textContent = `Added ‚Äú${goal.name}‚Äù to vault`; el.style.cssText='position:fixed;right:18px;bottom:18px;padding:10px 12px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;box-shadow:0 8px 20px rgba(16,160,110,0.12);font-weight:800'; document.body.appendChild(el);
setTimeout(()=>el.remove(),1500);
}

// remove from cart
function removeFromCart(id){
cart = cart.filter(g => g.id !== id);
saveCart();
renderCart();
renderCatalog();
}

// save & load
function saveCart(){ localStorage.setItem('vault_cart', JSON.stringify(cart)); }
function clearCart(){ cart = []; saveCart(); renderCart(); renderCatalog(); }

// render cart & totals
function renderCart(){
cartItemsEl.innerHTML = '';
if(cart.length === 0){
cartItemsEl.innerHTML = '<div class="small" style="color:var(--muted)">No goals yet ‚Äî add one to your vault.</div>';
  } else {
cart.forEach(g => {
const row = document.createElement('div');
row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='10px';
row.innerHTML = `<div style="flex:1"><div style="font-weight:800">${g.name}</div><div class="small">${fmtINR(g.monthly)} / m ‚Ä¢ ${g.months}m ‚Ä¢ ${g.rate}% ‚Üí ${fmtINR(g.target)}</div></div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        <button class="btn" style="padding:6px 8px" onclick="removeFromCart('${g.id}')">Remove</button>
      </div>`;
cartItemsEl.appendChild(row);
    });
  }

// totals
const monthlyTotal = cart.reduce((s,g)=>s+Number(g.monthly),0);
const combinedTarget = cart.reduce((s,g)=>s+Number(g.target),0);
cartMonthlyEl.textContent = fmtINR(monthlyTotal);
cartTargetEl.textContent = fmtINR(combinedTarget);
// update insights
const goalsCount = cart.length;
const insightGoals = document.getElementById('insightGoals');
const insightMonthly = document.getElementById('insightMonthly');
const insightTarget = document.getElementById('insightTarget');
if(insightGoals) insightGoals.textContent = String(goalsCount);
if(insightMonthly) insightMonthly.textContent = fmtINR(monthlyTotal);
if(insightTarget) insightTarget.textContent = fmtINR(combinedTarget);
}

// render catalog preview (left column list)
function renderCatalog(){
vaultCatalog.innerHTML = '';
if(cart.length === 0){
vaultCatalog.innerHTML = '<div class="small" style="color:var(--muted)">Your vault is empty ‚Äî add goals using the form.</div>';
return;
  }
cart.forEach(g=>{
const c = document.createElement('div');
c.style.display='flex'; c.style.justifyContent='space-between'; c.style.alignItems='center'; c.style.gap='8px'; c.style.padding='8px'; c.style.border='1px solid var(--border)'; c.style.borderRadius='10px'; c.style.background='#fff';
c.innerHTML = `<div><div style="font-weight:800">${g.name}</div><div class="small">${fmtINR(g.monthly)} / m ‚Ä¢ ${g.months}m ‚Ä¢ ${g.rate}%</div></div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        <div style="font-weight:800">${fmtINR(g.target)}</div>
        <div class="small">${fmtINR(g.monthly)} / month</div>
      </div>`;
vaultCatalog.appendChild(c);
  });
}

// init
document.getElementById('saveVaultBtn').addEventListener('click', ()=>{
if(cart.length === 0){ alert('Add at least one goal to save your vault.'); return; }
localStorage.setItem('vault_saved_'+Date.now(), JSON.stringify(cart));
alert('Vault saved in your browser (demo).');
});
document.getElementById('clearVaultBtn').addEventListener('click', ()=>{ if(confirm('Clear vault?')) clearCart(); });

// load initial
renderCart();
renderCatalog();

</script>

<!-- NEW: step/tab behavior + loan preview connectors -->
<script>
(function(){
  // map of step number -> element id to show
  const stepMap = {
    '1': 'step-1',
    '2': 'step-2',
    '3': 'schedule-confirm',
    '4': 'vault'
  };

  // --- KYC status helpers (client-side gating) ---
  const KYC_STATUS_KEY = 'kyc_status';
  const KYC_META_KEY = 'kyc_status_meta';
  const REVIEW_MS = 60 * 60 * 1000; // up to 1 hour review window
  const SYS_PROFILE_KEY = 'system_credit_profile';

  function getKycStatus(){
    return localStorage.getItem(KYC_STATUS_KEY) || 'not_started';
  }

  function getKycMeta(){
    try{ return JSON.parse(localStorage.getItem(KYC_META_KEY) || '{}'); }catch(e){ return {}; }
  }

  function setKycStatus(status, meta={}){
    const merged = {...getKycMeta(), ...meta, updatedAt: Date.now()};
    localStorage.setItem(KYC_STATUS_KEY, status);
    localStorage.setItem(KYC_META_KEY, JSON.stringify(merged));
    refreshKycStatusUI();
  }

  function etaText(meta){
    if(!meta || !meta.submittedAt) return 'up to 1 hour';
    const remaining = Math.max(0, meta.submittedAt + REVIEW_MS - Date.now());
    const mins = Math.ceil(remaining/60000);
    if(mins <= 0) return 'a few minutes';
    if(mins === 1) return '1 minute';
    if(mins <= 10) return `${mins} minutes`;
    return `${mins} minutes (est.)`;
  }

  function applyLocks(isLocked, message){
    const loanOverlay = document.getElementById('loanLockOverlay');
    const vaultOverlay = document.getElementById('vaultLockOverlay');
    const loanSec = document.getElementById('schedule-confirm');
    const vaultSec = document.getElementById('vault');
    if(loanSec) loanSec.classList.toggle('locked-blur', isLocked);
    if(vaultSec) vaultSec.classList.toggle('locked-blur', isLocked);
    if(loanOverlay){
      loanOverlay.style.display = isLocked ? 'flex' : 'none';
      loanOverlay.querySelector('.msg').textContent = message || 'üîí KYC required before viewing full loan schedule and repayment details.';
    }
    if(vaultOverlay){
      vaultOverlay.style.display = isLocked ? 'flex' : 'none';
      vaultOverlay.querySelector('.msg').textContent = message || 'üîí Savings vault unlocks after KYC verification.';
    }
  }

  // Scroll to Vault section and warn if locked
  function goToVault(){
    const vaultSec = document.getElementById('vault');
    if(vaultSec){ vaultSec.scrollIntoView({ behavior: 'smooth', block: 'start' }); }

    const overlay = document.getElementById('vaultLockOverlay');
    const locked = overlay && overlay.style.display === 'flex';
    if(locked){
      try { showToast('Savings Vault is locked until KYC verification.', 'warn'); }
      catch(_){ alert('Savings Vault is locked until KYC verification.'); }
    }
  }
  window.goToVault = goToVault;

  function refreshKycStatusUI(showToastNow=false){
    const status = getKycStatus();
    const meta = getKycMeta();
    const badge = document.getElementById('kycStatusBadge');
    const headline = document.getElementById('kycStatusHeadline');
    const copy = document.getElementById('kycStatusCopy');

    let badgeTxt = 'KYC ‚Ä¢ Not started';
    let badgeBg = '#f3f4f6';
    let badgeColor = '#111827';
    let headlineTxt = 'KYC required before loan access';
    let copyTxt = 'Complete KYC to unlock loan schedules, EMI planner, and credit insights. We show everything upfront but keep sensitive actions locked until verification.';
    let lockMessage = 'üîí KYC required before viewing full loan schedule and repayment details.';

    if(status === 'pending_review'){
      badgeTxt = 'KYC ‚Ä¢ Pending review';
      badgeBg = '#fef3c7';
      badgeColor = '#92400e';
      headlineTxt = 'Your KYC was submitted ‚Äî under review';
      copyTxt = `Our team is reviewing your details. This may take up to 1 hour (${etaText(meta)}). Loan/EMI remain locked until approval.`;
      lockMessage = 'üîí KYC under review ‚Äî access will be enabled soon.';
    } else if(status === 'verified'){
      badgeTxt = 'KYC ‚Ä¢ Verified';
      badgeBg = '#dcfce7';
      badgeColor = '#166534';
      headlineTxt = 'KYC verified ‚Äî access enabled';
      copyTxt = 'Loan schedules, EMI planner, and vault are now unlocked. You can proceed safely.';
      lockMessage = '';
      ensureSystemCreditProfile();
      renderCreditProfile();
    } else if(status === 'rejected'){
      badgeTxt = 'KYC ‚Ä¢ Rejected';
      badgeBg = '#fee2e2';
      badgeColor = '#991b1b';
      headlineTxt = 'KYC needs attention';
      copyTxt = (meta && meta.reason) ? meta.reason : 'Verification failed. Please re-upload clear documents and resubmit KYC.';
      lockMessage = 'üîí Access locked. Re-submit KYC to proceed.';
    }

    if(badge){ badge.textContent = badgeTxt; badge.style.background = badgeBg; badge.style.color = badgeColor; }
    if(headline) headline.textContent = headlineTxt;
    if(copy) copy.textContent = copyTxt;

    const locked = status !== 'verified';
    applyLocks(locked, lockMessage);
    if(locked){ renderCreditProfile(null); }

    if(showToastNow){
      try { showToast('KYC status refreshed', 'info'); } catch(_) {}
    }
  }

  window.refreshKycStatusUI = refreshKycStatusUI;
  window.setKycStatus = setKycStatus;
  window.getKycStatus = getKycStatus;

  function showToast(msg, type='warn'){
    const stack = document.getElementById('toastStack');
    if(!stack) { alert(msg); return; }
    const div = document.createElement('div');
    div.className = `toast ${type}`;
    div.textContent = msg;
    stack.appendChild(div);
    setTimeout(()=>{
      div.style.opacity = '0';
      div.style.transform = 'translateY(6px)';
    }, 2600);
    setTimeout(()=> div.remove(), 3200);
  }
  window.showToast = showToast;

  function loadSystemProfile(){
    try{ return JSON.parse(localStorage.getItem(SYS_PROFILE_KEY) || 'null'); }catch(e){ return null; }
  }

  function maskAccount(acct){
    if(!acct) return '‚Äî';
    const s = String(acct);
    if(s.length <= 4) return '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + s;
    return '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ' + s.slice(-4);
  }

  function ensureSystemCreditProfile(){
    const existing = loadSystemProfile();
    if(existing && existing.locked) { renderCreditProfile(existing); return existing; }
    // Generate deterministic-ish demo values based on stored loan inputs
    const p = Number(localStorage.getItem('loan_principal') || 250000);
    const baseScore = 720 + Math.floor((p % 90)); // 720-810
    const emiLimit = Math.max(5000, Math.round((p/120) * 0.45));
    const eligibility = Math.max(p, 200000);
    const profile = {
      creditScore: Math.min(810, baseScore),
      loanEligibility: eligibility,
      emiLimit,
      bankMasked: 'HDFC ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 3621',
      locked: true,
      generatedAt: Date.now()
    };
    localStorage.setItem(SYS_PROFILE_KEY, JSON.stringify(profile));
    renderCreditProfile(profile);
    return profile;
  }

  function renderCreditProfile(profile){
    const pf = profile || loadSystemProfile();
    const hint = document.getElementById('creditProfileHint');
    if(!pf){
      if(hint) hint.textContent = 'Will auto-fill after KYC is verified.';
      ['creditScoreVal','loanEligibilityVal','emiLimitVal','bankLinkedVal'].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent='‚Äî'; });
      return;
    }
    if(hint) hint.textContent = 'System-controlled values. Verified and read-only.';
    const fmt = (n)=> '‚Çπ' + Number(n||0).toLocaleString('en-IN');
    const setVal = (id,val)=>{ const el=document.getElementById(id); if(el) el.textContent = val; };
    setVal('creditScoreVal', pf.creditScore || '‚Äî');
    setVal('loanEligibilityVal', fmt(pf.loanEligibility||0));
    setVal('emiLimitVal', fmt(pf.emiLimit||0) + '/mo');
    setVal('bankLinkedVal', pf.bankMasked || '‚Äî');
  }

  const steps = Array.from(document.querySelectorAll('.step'));
  function setActiveStepNum(n){
    // hide all panels, show only mapped one
    Object.values(stepMap).forEach(id => {
      const el = document.getElementById(id);
      if(el) el.style.display = 'none';
    });
    const targetId = stepMap[String(n)];
    const targetEl = document.getElementById(targetId);
    if(targetEl) {
      // for 'schedule-confirm' which is a <section> we keep its display grid
      if(targetId === 'schedule-confirm') targetEl.style.display = 'grid';
      else targetEl.style.display = 'block';
    }
    // If not verified, allow viewing but warn when entering sensitive steps
    if(Number(n) > 2 && getKycStatus() !== 'verified'){
      showToast('KYC under review ‚Äî loan and EMI unlock after verification.', 'warn');
    }
    // update active class on pills
    steps.forEach(s => {
      if(s.dataset.step === String(n)) s.classList.add('active');
      else s.classList.remove('active');
    });
    // update hash
    try { history.replaceState(null, '', '#' + String(n)); } catch(e){}
    // when moving to schedule ensure the compact schedule is up-to-date
    if(String(n) === '3') {
      renderCompact();
      // also update KPIs from loan entry to compact panel (sync)
      updateCompactKPIsFromInputs();
    }
    // when moving to step 1 focus first input
    if(String(n) === '1'){
      const inp = document.getElementById('loanAmt');
      if(inp) inp.focus({preventScroll:true});
    }
  }

  // attach click to step pills
  steps.forEach(s => {
    s.addEventListener('click', () => {
      const num = s.dataset.step;
      setActiveStepNum(num);
    });
    s.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); setActiveStepNum(s.dataset.step); }
    });
  });

  // public helper used in your existing buttons
  window.goStep = function(n){ setActiveStepNum(n); };

  // read initial step from URL hash if present
  (function initFromHash(){
    const hash = location.hash.replace('#','');
    const start = ['1','2','3','4'].includes(hash) ? hash : '1';
    setActiveStepNum(start);
  })();

  refreshKycStatusUI();

  /* ---------- Loan preview sync ---------- */
  function calcEMI(P, n, annualRate){
    const r = annualRate/100/12;
    if(n <= 0) return 0;
    if(r === 0) return P / n;
    return (P * r * Math.pow(1+r,n)) / (Math.pow(1+r,n) - 1);
  }

  function updateLoanPreview(){
    const p = Number(document.getElementById('loanAmt').value) || 0;
    const n = Number(document.getElementById('months').value) || 1;
    const r = 6; // fixed
    const emi = calcEMI(p,n,r);
    const total = emi * n;
    const totalInterest = total - p;
    // update step1 kpis
    document.getElementById('emiVal').textContent = fmtINR(emi);
    document.getElementById('totalVal').textContent = fmtINR(total);
    document.getElementById('intVal').textContent = fmtINR(totalInterest);
    // save for schedule renderer
    try{
      localStorage.setItem('loan_principal', String(Math.round(p)));
      localStorage.setItem('loan_tenure', String(Math.round(n)));
      localStorage.setItem('loan_rate', String(r));
    }catch(e){}
    // update compact KPIs in schedule panel if visible
    document.getElementById('c-kpi-emi').textContent = fmtINR(emi);
    document.getElementById('c-kpi-interest').textContent = fmtINR(totalInterest);
    document.getElementById('c-kpi-total').textContent = fmtINR(total);
    // also update compact's smaller kpis (if you have the other small fields)
    // renderCompact also reads from localStorage; call it to refresh preview rows
    if(typeof renderCompact === 'function') renderCompact();
  }

  // A small function used earlier by quick buttons
  window.setScore = function(s){ document.getElementById('cibil').value = s; }
  window.setLoan = function(amount){ document.getElementById('loanAmt').value = amount; updateLoanPreview(); }
  window.setTenure = function(m){ document.getElementById('months').value = m; updateLoanPreview(); }

  // update compact KPIs from inputs (used when navigating to step 3)
  function updateCompactKPIsFromInputs(){
    const p = Number(localStorage.getItem('loan_principal')) || Number(document.getElementById('loanAmt').value) || 100000;
    const n = Number(localStorage.getItem('loan_tenure')) || Number(document.getElementById('months').value) || 24;
    const r = Number(localStorage.getItem('loan_rate')) || 6;
    const schedule = buildSchedule(p,n,r);
    document.getElementById('c-kpi-emi').textContent = fmtINR(schedule.emi);
    document.getElementById('c-kpi-interest').textContent = fmtINR(schedule.sumInterest);
    document.getElementById('c-kpi-total').textContent = fmtINR(schedule.totalPay);
    // prepare preview rows too
    window.__compactFullSchedule = schedule;
    renderCompact();
  }

  // wire loan inputs for live preview
  const loanInputs = ['loanAmt','months'];
  loanInputs.forEach(id => {
    const el = document.getElementById(id);
    if(el){
      el.addEventListener('input', () => {
        // small debounce not necessary here ‚Äî keep simple
        updateLoanPreview();
      });
    }
  });

  // when pressing the "View full schedule" button in compact panel, open the full schedule region
  document.getElementById('toggleFullBtn').addEventListener('click', () => {
    // ensure schedule data is in window
    updateCompactKPIsFromInputs();
    expandFull();
  });

  // initialize preview values on load
  updateLoanPreview();

  // Check server status on page load
  checkMainServerStatus();

  // Vault: suggested monthly based on ~10% of EMI
  function updateSuggestedMonthly(){
    try{
      const {P, nMonths, rate} = getLoanParams();
      const sched = buildSchedule(P, nMonths, rate);
      const suggest = Math.max(500, Math.round(sched.emi * 0.10));
      const el = document.getElementById('suggestedMonthly');
      if(el) el.textContent = fmtINR(suggest).replace('‚Çπ','‚Çπ');
    }catch(e){}
  }
  updateSuggestedMonthly();
  // refresh suggestion periodically in case loan changes
  setInterval(updateSuggestedMonthly, 2000);

  // Handle intents from landing page
  try{
    const intentKyc = localStorage.getItem('intent_open_kyc');
    const intentVault = localStorage.getItem('intent_open_vault');
    if(intentKyc === '1'){
      localStorage.removeItem('intent_open_kyc');
      // ensure step 2 is visible for context
      if(typeof window.goStep === 'function') window.goStep(2);
      if(typeof window.openKycPortal === 'function') setTimeout(()=>openKycPortal(), 200);
    }
    if(intentVault === '1'){
      localStorage.removeItem('intent_open_vault');
      if(typeof window.goStep === 'function') window.goStep(4);
      const v = document.getElementById('vault'); if(v) setTimeout(()=>v.scrollIntoView({behavior:'smooth'}), 300);
    }
  }catch(e){}

})();

// Check server status for main page
function checkMainServerStatus() {
  const statusEl = document.getElementById('serverStatus');
  const statusText = document.getElementById('statusText');
  
  fetch('http://127.0.0.1:3000/', {method: 'GET'})
    .then(res => {
      if (res.ok) {
        statusEl.style.display = 'block';
        statusEl.style.background = '#dcfce7';
        statusEl.style.color = '#166534';
        statusText.textContent = '‚úÖ Email Server Online';
      } else {
        throw new Error('Server error');
      }
    })
    .catch(() => {
      statusEl.style.display = 'block';
      statusEl.style.background = '#fef2f2';
      statusEl.style.color = '#dc2626';
      statusText.textContent = '‚ùå Email Server Offline';
    });
}
</script>

<!-- KYC Portal Modal: interactive multi-step KYC flow (client-side demo) -->
<style>
  /* KYC modal styles */
  #kycModal{position:fixed;inset:0;background:rgba(16,24,40,0.5);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:1200;animation:fadeIn 0.2s ease-out}
  #kycModal .panel{width:900px;max-width:92%;background:#fff;border-radius:16px;padding:24px;border:1.5px solid #e5e7eb;box-shadow:0 25px 60px rgba(0,0,0,0.15)}
  #kycModal .steps{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
  #kycModal .step-pill{padding:10px 14px;border-radius:10px;background:#f9fafb;border:1.5px solid #e5e7eb;font-weight:700;font-size:14px;color:#6b7280;transition:all 0.2s}
  #kycModal .step-pill.active{background:linear-gradient(135deg,#10B981,#34d399);color:#fff;border:none;box-shadow:0 4px 12px rgba(16,185,129,0.25)}
  #kycModal .form-row{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
  #kycModal input[type=file]{display:block;padding:10px;border-radius:10px;border:1.5px dashed #d1d5db;background:#f9fafb;cursor:pointer;transition:all 0.2s;width:100%}
  #kycModal input[type=file]:hover{border-color:#10B981;background:#f0fdf4}
  #kycModal .muted{color:#6b7280;font-size:14px;line-height:1.5}
  #kycModal .footer{display:flex;justify-content:space-between;align-items:center;margin-top:20px;padding-top:20px;border-top:1.5px solid #f3f4f6}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
</style>

<div id="kycModal" role="dialog" aria-modal="true" aria-labelledby="kycTitle">
  <div class="panel" role="document">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;margin-bottom:20px">
      <div style="flex:1">
        <h3 id="kycTitle" style="margin:0;font-size:26px;font-weight:900;color:#111827;letter-spacing:-0.3px">KYC Portal ‚Äî Complete verification</h3>
        <div class="muted" style="margin-top:8px;font-size:15px">A guided, demo-only KYC flow ‚Äî use sample files and simulate OTP.</div>
      </div>
      <div><button class="btn" onclick="closeKycPortal()" style="padding:10px 20px;font-weight:700;border-radius:10px">Close</button></div>
    </div>

    <div class="steps" id="kycStepsPills" style="margin-top:12px">
      <div class="step-pill active">1 ‚Ä¢ Identity</div>
      <div class="step-pill">2 ‚Ä¢ Address</div>
      <div class="step-pill">3 ‚Ä¢ Income</div>
      <div class="step-pill">4 ‚Ä¢ Bank Details</div>
      <div class="step-pill">5 ‚Ä¢ e-KYC</div>
      <div class="step-pill">6 ‚Ä¢ Selfie</div>
      <div class="step-pill">7 ‚Ä¢ Review</div>
    </div>

    <!-- Step containers -->
    <div id="kycStepWrap">
      <!-- Step 1: Identity -->
      <div class="kyc-step" data-step="1">
        <div style="font-weight:800;font-size:18px;color:#111827;margin-bottom:8px">Identity Documents</div>
        <div class="muted" style="margin-bottom:16px">Upload one government ID (PAN / Aadhaar / Passport)</div>
        <div class="form-row" style="margin-top:16px">
          <div style="flex:1;min-width:200px">
            <label class="small" style="font-weight:700;color:#374151;margin-bottom:6px;display:block">ID Type</label>
            <select id="kyc_id_type" style="width:100%;padding:12px;border-radius:10px;border:1.5px solid #d1d5db;font-size:14px;background:#fff;transition:all 0.2s">
              <option>PAN</option>
              <option>Aadhaar</option>
              <option>Passport</option>
            </select>
          </div>
          <div style="flex:2;min-width:300px">
            <label class="small" style="font-weight:700;color:#374151;margin-bottom:6px;display:block">Upload ID (PDF / Image)</label>
            <input id="kyc_id_file" type="file" accept=".pdf,image/*">
            <div id="kyc_id_file_name" class="muted" style="margin-top:8px;font-size:13px">No file chosen</div>
          </div>
        </div>
      </div>

      <!-- Step 2: Address -->
      <div class="kyc-step" data-step="2" style="display:none">
        <div style="font-weight:800">Address Proof</div>
        <div class="muted" style="margin-top:6px">Upload a utility bill, Aadhaar, passport, rent agreement or bank statement.</div>
        <div class="form-row" style="margin-top:10px">
          <div style="flex:1">
            <label class="small">Address Line <span style="color:#ef4444">*</span></label>
            <input id="kyc_addr_line" type="text" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6edf3" placeholder="House, street, area" required>
          </div>
          <div style="flex:1">
            <label class="small">City / District <span style="color:#ef4444">*</span></label>
            <input id="kyc_city" type="text" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6edf3" placeholder="City" required>
          </div>
        </div>
        <div class="form-row" style="margin-top:10px">
          <div style="flex:2">
            <label class="small">Upload Address Proof</label>
            <input id="kyc_addr_file" type="file" accept=".pdf,image/*">
            <div id="kyc_addr_file_name" class="muted" style="margin-top:6px">No file chosen</div>
          </div>
        </div>
      </div>

      <!-- Step 3: Income -->
      <div class="kyc-step" data-step="3" style="display:none">
        <div style="font-weight:800">Income Documents</div>
        <div class="muted" style="margin-top:6px">Choose salaried or self-employed and upload relevant documents.</div>
        <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
          <label><input type="radio" name="kyc_income_type" value="salaried" checked> Salaried</label>
          <label><input type="radio" name="kyc_income_type" value="self"> Self-employed</label>
        </div>
        <div class="form-row" style="margin-top:10px">
          <div style="flex:1">
            <label class="small">Monthly Income (INR) <span style="color:#ef4444">*</span></label>
            <input id="kyc_income_amount" type="number" min="1" step="1000" placeholder="e.g. 45000" required style="padding:10px;border-radius:10px;border:1.5px solid #d1d5db;width:100%">
            <div class="muted" id="kyc_income_hint" style="margin-top:6px">Self-employed under ‚Çπ30,000/month requires last 6 months bank statement.</div>
          </div>
        </div>
        <div class="form-row" style="margin-top:10px">
          <div style="flex:1">
            <label class="small">Upload Income Proof</label>
            <input id="kyc_income_file" type="file" accept=".pdf,image/*">
            <div id="kyc_income_file_name" class="muted" style="margin-top:6px">No file chosen</div>
          </div>
        </div>
        <div class="form-row" id="kyc_bank_stmt_row" style="margin-top:10px; display:none">
          <div style="flex:1">
            <label class="small">Upload Bank Statement (last 6 months)</label>
            <input id="kyc_bank_stmt_file" type="file" accept=".pdf,image/*">
            <div id="kyc_bank_stmt_file_name" class="muted" style="margin-top:6px">No file chosen</div>
            <div class="muted" id="kyc_bank_stmt_hint" style="margin-top:6px;color:#b45309">Required because self-employed income is under ‚Çπ30,000/month.</div>
          </div>
        </div>
      </div>

      <!-- Step 4: Bank Details -->
      <div class="kyc-step" data-step="4" style="display:none">
        <div style="font-weight:800;font-size:18px;color:#111827;margin-bottom:8px">Bank Details</div>
        <div class="muted" style="margin-bottom:16px">Provide your bank account details for loan disbursement and EMI setup (demo only).</div>
        <div class="form-row" style="margin-top:16px">
          <div style="flex:1;min-width:250px">
            <label class="small" style="font-weight:700;color:#374151;margin-bottom:6px;display:block">Account Number <span style="color:#ef4444">*</span></label>
            <input id="kyc_bank_account" type="text" placeholder="e.g. 123456789012" required minlength="9" maxlength="18" pattern="[0-9]{9,18}" style="width:100%;padding:12px;border-radius:10px;border:1.5px solid #d1d5db;font-size:14px">
          </div>
          <div style="flex:1;min-width:200px">
            <label class="small" style="font-weight:700;color:#374151;margin-bottom:6px;display:block">IFSC Code <span style="color:#ef4444">*</span></label>
            <input id="kyc_bank_ifsc" type="text" placeholder="e.g. SBIN0001234" required pattern="[A-Z]{4}0[A-Z0-9]{6}" maxlength="11" style="width:100%;padding:12px;border-radius:10px;border:1.5px solid #d1d5db;font-size:14px;text-transform:uppercase">
          </div>
        </div>
        <div class="form-row" style="margin-top:12px">
          <div style="flex:1;min-width:250px">
            <label class="small" style="font-weight:700;color:#374151;margin-bottom:6px;display:block">Bank Name <span style="color:#ef4444">*</span></label>
            <input id="kyc_bank_name" type="text" placeholder="e.g. State Bank of India" required style="width:100%;padding:12px;border-radius:10px;border:1.5px solid #d1d5db;font-size:14px">
          </div>
          <div style="flex:1;min-width:200px">
            <label class="small" style="font-weight:700;color:#374151;margin-bottom:6px;display:block">Branch Name <span style="color:#ef4444">*</span></label>
            <input id="kyc_bank_branch" type="text" placeholder="e.g. Connaught Place" required style="width:100%;padding:12px;border-radius:10px;border:1.5px solid #d1d5db;font-size:14px">
          </div>
        </div>
        <div class="form-row" style="margin-top:12px">
          <div style="flex:1;min-width:250px">
            <label class="small" style="font-weight:700;color:#374151;margin-bottom:6px;display:block">Account Type <span style="color:#ef4444">*</span></label>
            <select id="kyc_bank_account_type" required style="width:100%;padding:12px;border-radius:10px;border:1.5px solid #d1d5db;font-size:14px;background:#fff">
              <option value="">Select account type</option>
              <option value="savings">Savings Account</option>
              <option value="current">Current Account</option>
              <option value="salary">Salary Account</option>
            </select>
          </div>
          <div style="flex:1;min-width:200px">
            <label class="small" style="font-weight:700;color:#374151;margin-bottom:6px;display:block">Account Holder Name <span style="color:#ef4444">*</span></label>
            <input id="kyc_bank_holder_name" type="text" placeholder="As per bank records" required style="width:100%;padding:12px;border-radius:10px;border:1.5px solid #d1d5db;font-size:14px">
          </div>
        </div>
        <div class="muted" style="margin-top:14px;padding:12px;background:#f0f9ff;border:1.5px solid #bfdbfe;border-radius:10px">
          üí° <strong>Demo Note:</strong> This is a simulation. Your bank details are stored locally only and not sent to any server.
        </div>
      </div>

      <!-- Step 5: e-KYC simulation -->
      <div class="kyc-step" data-step="5" style="display:none">
        <div style="font-weight:800;font-size:18px;color:#111827;margin-bottom:8px">e-KYC ‚Äî Aadhaar OTP (demo)</div>
        <div class="muted" style="margin-bottom:16px">Enter a mobile number to simulate Aadhaar OTP verification (demo only).</div>
        <div style="display:flex;gap:12px;margin-top:16px;align-items:flex-end;flex-wrap:wrap">
          <div>
            <label class="small" style="font-weight:700;color:#374151;margin-bottom:6px;display:block">Mobile Number <span style="color:#ef4444">*</span></label>
            <input id="kyc_mobile" type="text" placeholder="8539801985" required pattern="[6-9][0-9]{9}" maxlength="10" style="padding:12px;border-radius:10px;border:1.5px solid #d1d5db;width:220px;font-size:14px">
          </div>
          <button class="btn" id="kyc_send_otp_btn" style="padding:12px 20px;font-weight:700;border-radius:10px;background:linear-gradient(135deg,#10B981,#34d399);color:#fff;border:none;box-shadow:0 4px 12px rgba(16,185,129,0.2)">Send OTP</button>
          <div style="display:none" id="kyc_otp_wrap">
            <label class="small" style="font-weight:700;color:#374151;margin-bottom:6px;display:block">Enter OTP</label>
            <input id="kyc_otp" type="text" placeholder="Enter OTP" style="padding:12px;border-radius:10px;border:1.5px solid #d1d5db;width:160px;font-size:14px">
          </div>
          <button class="btn" id="kyc_verify_otp_btn" style="display:none;padding:12px 20px;font-weight:700;border-radius:10px;background:linear-gradient(135deg,#10B981,#34d399);color:#fff;border:none;box-shadow:0 4px 12px rgba(16,185,129,0.2)">Verify</button>
        </div>
        <div id="kyc_otp_status" class="muted" style="margin-top:12px;padding:10px 14px;background:#f9fafb;border-radius:8px;font-size:13px">OTP not sent</div>
      </div>

      <!-- Step 6: Selfie Verification -->
      <div class="kyc-step" data-step="6" style="display:none">
        <div style="font-weight:800;font-size:18px;color:#111827;margin-bottom:8px">Selfie Verification</div>
        <div class="muted" style="margin-bottom:16px">Capture a clear selfie for identity verification. Requirements: 75% face visible, clear background.</div>
        
        <div style="display:flex;gap:20px;margin-top:16px;flex-wrap:wrap">
          <div style="flex:1;min-width:300px">
            <div style="position:relative;width:100%;max-width:400px;aspect-ratio:4/3;background:#f9fafb;border:2px dashed #d1d5db;border-radius:12px;overflow:hidden">
              <video id="kyc_video" autoplay playsinline style="width:100%;height:100%;object-fit:cover;display:none"></video>
              <canvas id="kyc_canvas" style="width:100%;height:100%;object-fit:cover;display:none"></canvas>
              <div id="kyc_preview" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px">
                <div style="font-size:48px">üì∏</div>
                <div style="font-weight:700;color:#6b7280">Click "Start Camera" to begin</div>
              </div>
              <div id="kyc_face_indicator" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:200px;height:250px;border:3px solid #10B981;border-radius:50%;display:none;pointer-events:none"></div>
            </div>
            
            <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
              <button class="btn" id="kyc_start_camera" style="padding:10px 18px;font-weight:700;border-radius:10px;background:linear-gradient(135deg,#10B981,#34d399);color:#fff;border:none">üì∑ Start Camera</button>
              <button class="btn" id="kyc_capture" style="padding:10px 18px;font-weight:700;border-radius:10px;display:none">üì∏ Capture Photo</button>
              <button class="btn" id="kyc_retake" style="padding:10px 18px;font-weight:700;border-radius:10px;display:none">üîÑ Retake</button>
            </div>
          </div>
          
          <div style="flex:1;min-width:280px">
            <div style="background:#f0fdf4;border:1.5px solid #86efac;border-radius:12px;padding:16px;margin-bottom:16px">
              <div style="font-weight:700;color:#166534;margin-bottom:10px">‚úÖ Requirements Checklist</div>
              <div id="kyc_req_face" style="padding:8px;margin-bottom:6px;border-radius:8px;background:#fff;display:flex;align-items:center;gap:8px">
                <span style="font-size:20px">‚ö™</span>
                <span style="font-size:13px;color:#6b7280">Face 75% visible</span>
              </div>
              <div id="kyc_req_bg" style="padding:8px;margin-bottom:6px;border-radius:8px;background:#fff;display:flex;align-items:center;gap:8px">
                <span style="font-size:20px">‚ö™</span>
                <span style="font-size:13px;color:#6b7280">Clear background</span>
              </div>
              <div id="kyc_req_complete" style="padding:8px;border-radius:8px;background:#fff;display:flex;align-items:center;gap:8px">
                <span style="font-size:20px">‚ö™</span>
                <span style="font-size:13px;color:#6b7280">Photo captured</span>
              </div>
            </div>
            
            <div id="kyc_selfie_status" style="padding:12px 16px;background:#f9fafb;border-radius:10px;font-size:13px;color:#6b7280">
              üìã Waiting to start camera...
            </div>
          </div>
        </div>
      </div>

      <!-- Step 7: Review & Submit -->
      <div class="kyc-step" data-step="7" style="display:none">
        <div style="font-weight:800;font-size:18px;color:#111827;margin-bottom:8px">Review & Submit</div>
        <div class="muted" style="margin-bottom:16px">Confirm your uploads and submit. This demo saves the data locally only.</div>
        <div id="kyc_review" style="margin-top:10px"></div>
      </div>
    </div>

    <div class="footer">
      <div style="display:flex;gap:10px">
        <button class="btn" onclick="kycPrev()" id="kycPrevBtn" style="padding:12px 24px;font-weight:700;border-radius:10px;border:1.5px solid #d1d5db;background:#fff;transition:all 0.2s">‚Üê Back</button>
        <button class="btn primary" onclick="kycNext()" id="kycNextBtn" style="padding:12px 28px;font-weight:800;border-radius:10px;background:linear-gradient(135deg,#10B981,#34d399);color:#fff;border:none;box-shadow:0 6px 16px rgba(16,185,129,0.25);transition:all 0.2s">Next ‚Üí</button>
      </div>
      <div class="muted" style="font-size:13px;color:#9ca3af">Progress is saved locally in your browser.</div>
    </div>
  </div>
</div>

<script>
  // KYC modal script
  (function(){
    let kycStep = 1;
    function showStep(n){
      kycStep = n;
      document.querySelectorAll('#kycModal .kyc-step').forEach(el => el.style.display = (Number(el.dataset.step) === n) ? 'block' : 'none');
      const pills = document.querySelectorAll('#kycStepsPills .step-pill');
      pills.forEach((p,i)=> p.classList.toggle('active', (i+1)===n));
      document.getElementById('kycPrevBtn').style.display = (n===1)?'none':'inline-block';
      document.getElementById('kycNextBtn').textContent = (n===7)?'Submit':'Next ‚Üí';
      // on review build summary
      if(n===7) buildReview();
    }

    window.openKycPortal = function(){
      document.getElementById('kycModal').style.display = 'flex';
      showStep(1);
      
      // load saved data if any
      const saved = JSON.parse(localStorage.getItem('kyc_data')||'null');
      if(saved){
        try{ document.getElementById('kyc_id_type').value = saved.id_type || 'PAN'; }catch(e){}
      }
    };

    // Helper function to show email setup info (call manually if needed)
    function showEmailSetupInfo() {
      alert('üìß Email notifications are optional.\n\nTo enable email alerts:\n1. Check README_KYC_MAILER.md for setup\n2. Configure backend server or use EmailJS\n\nKYC portal works without email setup.');
    }
    
    window.closeKycPortal = function(){ 
      // Stop camera if running
      if(videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      if(faceDetectionInterval) {
        clearInterval(faceDetectionInterval);
        faceDetectionInterval = null;
      }
      document.getElementById('kycModal').style.display = 'none'; 
    };

    window.kycNext = async function(){
      // Validate current step before proceeding
      if(!validateCurrentStep(kycStep)){
        return; // Don't proceed if validation fails
      }
      
      if(kycStep < 7){ showStep(kycStep+1); return; }
      
      // submit (save under timestamped key and also keep legacy key)
      const data = collectKycData();
      try{
        const key = 'kyc_saved_' + Date.now();
        localStorage.setItem(key, JSON.stringify(data));
        localStorage.setItem('kyc_data', JSON.stringify(data));
        // maintain an index of saved keys for easy lookup
        const idx = JSON.parse(localStorage.getItem('kyc_index') || '[]');
        idx.push(key);
        localStorage.setItem('kyc_index', JSON.stringify(idx));
      }catch(e){ /* ignore storage errors */ }

      // attempt to notify backend API to send email (if you run the provided server)
      let emailSent = false;
      // First try EmailJS (client-side) if configured
      try{
        const svc = localStorage.getItem('emailjs_service');
        const tmpl = localStorage.getItem('emailjs_template');
        const pub = localStorage.getItem('emailjs_public');
        if(svc && tmpl && pub && window.emailjs && typeof emailjs.send === 'function'){
          const params = {
            id_type: data.id_type || '',
            id_file: data.id_file || '',
            address_line: data.address_line || '',
            city: data.city || '',
            addr_file: data.addr_file || '',
            income_type: data.income_type || '',
            income_file: data.income_file || '',
            mobile: data.mobile || '',
            otp_status: data.otp_status || '',
            kyc_json: JSON.stringify(data, null, 2)
          };
          try{
            const res = await emailjs.send(svc, tmpl, params);
            emailSent = true;
            alert('KYC sent via EmailJS to configured recipient.');
          }catch(err){ console.log('EmailJS send failed', err); }
        }
      }catch(e){ console.log('EmailJS attempt failed', e); }
      try{
        const token = localStorage.getItem('auth_token');
        const headers = {'Content-Type':'application/json'};
        if(token) headers['Authorization'] = 'Bearer ' + token;
        fetch('http://127.0.0.1:3000/api/submit-kyc', {method:'POST', headers, body: JSON.stringify({data})})
          .then(res => {
            if(res.ok) return res.json();
            throw new Error('backend error');
          })
          .then(j => { 
            if(j && j.sent) {
              emailSent = true;
              alert('KYC submitted successfully! Admin has been notified by email.');
            } else {
              throw new Error('Email not sent');
            }
          })
          .catch((error)=>{ 
            console.log('Backend email failed:', error);
            // Fallback: open mail client for manual notification
            sendManualEmail(data);
          });
      }catch(e){
        console.log('Fetch failed:', e);
        sendManualEmail(data);
      }

      // Update local KYC status to pending review and inform user
      try{
        setKycStatus('pending_review', {submittedAt: Date.now(), reason: ''});
        showToast('KYC submitted. Under review (up to 1 hour).', 'warn');
      }catch(_){ }

      // Show success message
      alert('‚úÖ KYC data saved successfully!\n\nYour verification is complete and stored locally in your browser.');
      closeKycPortal();
    };
    window.kycPrev = function(){ if(kycStep>1) showStep(kycStep-1); };

    // file inputs preview and validation clearing
    function wireFile(id, labelId){
      const el = document.getElementById(id); const lab = document.getElementById(labelId);
      if(!el) return;
      el.addEventListener('change', ()=>{ 
        lab.textContent = el.files.length ? el.files[0].name : 'No file chosen';
        // Clear error highlighting when user selects a file
        el.classList.remove('field-error');
      });
    }
    wireFile('kyc_id_file','kyc_id_file_name');
    wireFile('kyc_addr_file','kyc_addr_file_name');
    wireFile('kyc_income_file','kyc_income_file_name');
    wireFile('kyc_bank_stmt_file','kyc_bank_stmt_file_name');

    function updateIncomeRequirement(){
      const typeVal = (document.querySelector('input[name="kyc_income_type"]:checked')||{}).value || 'salaried';
      const amtVal = Number(document.getElementById('kyc_income_amount').value || 0);
      const row = document.getElementById('kyc_bank_stmt_row');
      const hint = document.getElementById('kyc_income_hint');
      const bankHint = document.getElementById('kyc_bank_stmt_hint');

      const needsBankStmt = typeVal === 'self' && amtVal > 0 && amtVal < 30000;
      row.style.display = needsBankStmt ? 'block' : 'none';
      bankHint.style.display = needsBankStmt ? 'block' : 'none';
      hint.textContent = needsBankStmt ? 'Income under ‚Çπ30,000/month (self-employed) ‚Üí upload last 6 months bank statement.' : 'Self-employed under ‚Çπ30,000/month requires last 6 months bank statement.';
    }

    // income type/amount listeners
    document.querySelectorAll('input[name="kyc_income_type"]').forEach(r => r.addEventListener('change', updateIncomeRequirement));
    const incAmtEl = document.getElementById('kyc_income_amount');
    if (incAmtEl) incAmtEl.addEventListener('input', updateIncomeRequirement);
    updateIncomeRequirement();

    // Add input event listeners to clear error highlighting
    ['kyc_addr_line', 'kyc_city', 'kyc_mobile', 'kyc_income_amount', 'kyc_bank_account', 'kyc_bank_ifsc', 'kyc_bank_name', 'kyc_bank_branch', 'kyc_bank_account_type', 'kyc_bank_holder_name'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', () => {
          el.classList.remove('field-error');
        });
      }
    });

    // OTP simulation - with safer element access
    const sendOtpBtn = document.getElementById('kyc_send_otp_btn');
    const verifyOtpBtn = document.getElementById('kyc_verify_otp_btn');
    
    console.log('OTP buttons found:', {sendOtpBtn: !!sendOtpBtn, verifyOtpBtn: !!verifyOtpBtn});
    
    if(sendOtpBtn) {
      sendOtpBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        const mobileInput = document.getElementById('kyc_mobile');
        const otpStatus = document.getElementById('kyc_otp_status');
        const otpWrap = document.getElementById('kyc_otp_wrap');
        
        const m = mobileInput.value.trim();
        
        // Validate mobile number
        if(!m) {
          otpStatus.innerHTML = '<span style="color:#ef4444;font-weight:600">‚ö†Ô∏è Please enter a mobile number</span>';
          mobileInput.focus();
          return;
        }
        
        if(!/^[6-9]\d{9}$/.test(m)){ 
          otpStatus.innerHTML = '<span style="color:#ef4444;font-weight:600">‚ö†Ô∏è Enter a valid 10-digit mobile starting with 6-9</span>'; 
          mobileInput.focus();
          return; 
        }
        
        // Generate OTP
        window.__kyc_demo_otp = String(Math.floor(100000 + Math.random()*900000));
        
        // Show OTP input and verify button
        if(otpWrap) otpWrap.style.display = 'block';
        if(verifyOtpBtn) verifyOtpBtn.style.display = 'inline-block';
        
        // Update status with success message
        otpStatus.innerHTML = '<span style="color:#10B981;font-weight:700;font-size:14px">‚úÖ OTP sent successfully (demo): <strong>' + window.__kyc_demo_otp + '</strong></span>';
        
        // Focus on OTP input
        setTimeout(() => {
          const otpInput = document.getElementById('kyc_otp');
          if(otpInput) otpInput.focus();
        }, 100);
      });
    }
    
    if(verifyOtpBtn) {
      verifyOtpBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        const otpInput = document.getElementById('kyc_otp');
        const otpStatus = document.getElementById('kyc_otp_status');
        
        const v = otpInput.value.trim();
        
        if(!v){ 
          otpStatus.innerHTML = '<span style="color:#ef4444;font-weight:600">‚ö†Ô∏è Please enter the OTP</span>'; 
          otpInput.focus();
          return; 
        }
        
        if(v === window.__kyc_demo_otp){ 
          otpStatus.innerHTML = '<span style="color:#10B981;font-weight:700;font-size:15px">‚úÖ Verified successfully!</span>';
          otpInput.disabled = true;
          verifyOtpBtn.disabled = true;
          verifyOtpBtn.style.opacity = '0.6';
        } else { 
          otpStatus.innerHTML = '<span style="color:#ef4444;font-weight:700">‚ùå Invalid OTP - Please try again with: <strong>' + window.__kyc_demo_otp + '</strong></span>'; 
          otpInput.value = '';
          otpInput.focus();
        }
      });
    }

    // Selfie Verification with Face Detection
    let videoStream = null;
    let selfieData = null;
    let faceDetectionInterval = null;

    document.getElementById('kyc_start_camera').addEventListener('click', async ()=>{
      try {
        const video = document.getElementById('kyc_video');
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: 640, height: 480 } });
        video.srcObject = videoStream;
        video.style.display = 'block';
        document.getElementById('kyc_preview').style.display = 'none';
        document.getElementById('kyc_capture').style.display = 'inline-block';
        document.getElementById('kyc_start_camera').style.display = 'none';
        document.getElementById('kyc_face_indicator').style.display = 'block';
        document.getElementById('kyc_selfie_status').innerHTML = '<span style="color:#10B981">üìπ Camera active - Position your face in the frame</span>';
        
        // Start face detection simulation
        startFaceDetection();
      } catch(e) {
        document.getElementById('kyc_selfie_status').innerHTML = '<span style="color:#ef4444">‚ùå Camera access denied. Please allow camera permission.</span>';
      }
    });

    function startFaceDetection() {
      let faceVisible = false;
      let bgClear = false;
      
      faceDetectionInterval = setInterval(()=>{
        const video = document.getElementById('kyc_video');
        if(!video.srcObject) return;
        
        // Simulate face detection (in production, use TensorFlow.js or face-api.js)
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const brightness = calculateBrightness(imageData);
        const contrast = calculateContrast(imageData);
        
        // Simulate face visibility check (>75% visible)
        faceVisible = brightness > 80 && brightness < 200;
        
        // Simulate background clarity check
        bgClear = contrast > 30;
        
        // Update UI indicators
        updateRequirementIndicator('kyc_req_face', faceVisible);
        updateRequirementIndicator('kyc_req_bg', bgClear);
        
        // Update face indicator color
        const indicator = document.getElementById('kyc_face_indicator');
        if(faceVisible && bgClear) {
          indicator.style.borderColor = '#10B981';
          indicator.style.boxShadow = '0 0 20px rgba(16,185,129,0.5)';
        } else {
          indicator.style.borderColor = '#f59e0b';
          indicator.style.boxShadow = '0 0 20px rgba(245,158,11,0.3)';
        }
      }, 500);
    }

    function calculateBrightness(imageData) {
      let sum = 0;
      for(let i = 0; i < imageData.data.length; i += 4) {
        sum += (imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3;
      }
      return sum / (imageData.data.length / 4);
    }

    function calculateContrast(imageData) {
      const brightness = calculateBrightness(imageData);
      let variance = 0;
      for(let i = 0; i < imageData.data.length; i += 4) {
        const pixelBrightness = (imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3;
        variance += Math.pow(pixelBrightness - brightness, 2);
      }
      return Math.sqrt(variance / (imageData.data.length / 4));
    }

    function updateRequirementIndicator(id, passed) {
      const el = document.getElementById(id);
      const icon = el.querySelector('span:first-child');
      const text = el.querySelector('span:last-child');
      if(passed) {
        icon.textContent = 'üü¢';
        text.style.color = '#166534';
        text.style.fontWeight = '700';
      } else {
        icon.textContent = '‚ö™';
        text.style.color = '#6b7280';
        text.style.fontWeight = '400';
      }
    }

    document.getElementById('kyc_capture').addEventListener('click', ()=>{
      const video = document.getElementById('kyc_video');
      const canvas = document.getElementById('kyc_canvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      
      // Validate requirements
      const faceReq = document.getElementById('kyc_req_face').querySelector('span:first-child').textContent === 'üü¢';
      const bgReq = document.getElementById('kyc_req_bg').querySelector('span:first-child').textContent === 'üü¢';
      
      if(!faceReq || !bgReq) {
        document.getElementById('kyc_selfie_status').innerHTML = '<span style="color:#ef4444">‚ùå Requirements not met. Ensure face is 75% visible and background is clear.</span>';
        return;
      }
      
      // Capture successful
      selfieData = canvas.toDataURL('image/jpeg', 0.9);
      canvas.style.display = 'block';
      video.style.display = 'none';
      document.getElementById('kyc_capture').style.display = 'none';
      document.getElementById('kyc_retake').style.display = 'inline-block';
      document.getElementById('kyc_face_indicator').style.display = 'none';
      
      // Stop camera
      if(videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      
      // Stop face detection
      if(faceDetectionInterval) {
        clearInterval(faceDetectionInterval);
        faceDetectionInterval = null;
      }
      
      // Update all indicators to green with checkmark
      updateRequirementIndicator('kyc_req_face', true);
      updateRequirementIndicator('kyc_req_bg', true);
      updateRequirementIndicator('kyc_req_complete', true);
      document.getElementById('kyc_selfie_status').innerHTML = '<span style="color:#10B981;font-weight:700">‚úÖ Selfie captured successfully!</span>';
    });

    document.getElementById('kyc_retake').addEventListener('click', ()=>{
      const canvas = document.getElementById('kyc_canvas');
      canvas.style.display = 'none';
      document.getElementById('kyc_preview').style.display = 'flex';
      document.getElementById('kyc_retake').style.display = 'none';
      document.getElementById('kyc_start_camera').style.display = 'inline-block';
      selfieData = null;
      
      // Reset indicators
      updateRequirementIndicator('kyc_req_face', false);
      updateRequirementIndicator('kyc_req_bg', false);
      updateRequirementIndicator('kyc_req_complete', false);
      document.getElementById('kyc_selfie_status').innerHTML = '<span style="color:#6b7280">üìã Ready to capture new selfie</span>';
    });

    function collectKycData(){
      return {
        id_type: document.getElementById('kyc_id_type').value,
        id_file: (document.getElementById('kyc_id_file').files[0]||{}).name || null,
        address_line: document.getElementById('kyc_addr_line').value,
        city: document.getElementById('kyc_city').value,
        addr_file: (document.getElementById('kyc_addr_file').files[0]||{}).name || null,
        income_type: (document.querySelector('input[name="kyc_income_type"]:checked')||{}).value || 'salaried',
        income_amount: document.getElementById('kyc_income_amount').value,
        income_file: (document.getElementById('kyc_income_file').files[0]||{}).name || null,
        bank_stmt_file: (document.getElementById('kyc_bank_stmt_file')?.files[0]||{}).name || null,
        bank_account: document.getElementById('kyc_bank_account').value,
        bank_ifsc: document.getElementById('kyc_bank_ifsc').value,
        bank_name: document.getElementById('kyc_bank_name').value,
        bank_branch: document.getElementById('kyc_bank_branch').value,
        bank_account_type: document.getElementById('kyc_bank_account_type').value,
        bank_holder_name: document.getElementById('kyc_bank_holder_name').value,
        mobile: document.getElementById('kyc_mobile').value,
        otp_status: document.getElementById('kyc_otp_status').textContent,
        selfie_captured: selfieData ? 'Yes' : 'No',
        selfie_data: selfieData
      };
    }

    // EmailJS helpers: dynamic load and setup UI
    function loadEmailJs(publicKey){
      if(window.emailjs) return; // already loaded
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js';
      s.onload = ()=>{ try{ emailjs.init(publicKey); console.log('EmailJS initialized'); }catch(e){ console.log('EmailJS init failed', e); } };
      document.head.appendChild(s);
    }

    window.openEmailJsSetup = function(){
      const currentService = localStorage.getItem('emailjs_service') || '';
      const currentTemplate = localStorage.getItem('emailjs_template') || '';
      const currentPublic = localStorage.getItem('emailjs_public') || '';
      const service = prompt('EmailJS Service ID (e.g. service_xxx):', currentService);
      if(service === null) return;
      const template = prompt('EmailJS Template ID (e.g. template_xxx):', currentTemplate);
      if(template === null) return;
      const pub = prompt('EmailJS Public Key / User ID (e.g. user_xxx):', currentPublic);
      if(pub === null) return;
      localStorage.setItem('emailjs_service', service);
      localStorage.setItem('emailjs_template', template);
      localStorage.setItem('emailjs_public', pub);
      try{ loadEmailJs(pub); alert('EmailJS configured locally. Sending will use your template and service.'); }catch(e){ alert('Configured but failed to load EmailJS script.'); }
    };

    // Auto-init EmailJS if config present
    (function(){
      const pub = localStorage.getItem('emailjs_public');
      if(pub){ loadEmailJs(pub); }
    })();

    function validateCurrentStep(step) {
      let isValid = true;
      let errorMsg = '';

      switch(step) {
        case 1: // Identity
          const idFile = document.getElementById('kyc_id_file').files[0];
          if (!idFile) {
            errorMsg = 'Please upload an identity document (PAN/Aadhaar/Passport)';
            isValid = false;
          }
          break;

        case 2: // Address
          const addrLine = document.getElementById('kyc_addr_line').value.trim();
          const city = document.getElementById('kyc_city').value.trim();
          const addrFile = document.getElementById('kyc_addr_file').files[0];
          
          if (!addrLine || !city) {
            errorMsg = 'Please fill in both address line and city';
            isValid = false;
          } else if (!addrFile) {
            errorMsg = 'Please upload an address proof document';
            isValid = false;
          }
          break;

        case 3: // Income
          const incomeFile = document.getElementById('kyc_income_file').files[0];
          const incomeType = (document.querySelector('input[name="kyc_income_type"]:checked')||{}).value || 'salaried';
          const incomeAmountVal = Number(document.getElementById('kyc_income_amount').value || 0);
          const bankStmtFile = document.getElementById('kyc_bank_stmt_file')?.files[0];

          if (incomeAmountVal <= 0) {
            errorMsg = 'Please enter your monthly income amount';
            isValid = false;
          } else if (!incomeFile) {
            errorMsg = 'Please upload an income proof document';
            isValid = false;
          } else if (incomeType === 'self' && incomeAmountVal < 30000 && !bankStmtFile) {
            errorMsg = 'For self-employed income under ‚Çπ30,000/month, upload last 6 months bank statement.';
            isValid = false;
          }
          break;

        case 4: // Bank Details
          const bankAccount = document.getElementById('kyc_bank_account').value.trim();
          const bankIfsc = document.getElementById('kyc_bank_ifsc').value.trim();
          const bankName = document.getElementById('kyc_bank_name').value.trim();
          const bankBranch = document.getElementById('kyc_bank_branch').value.trim();
          const bankAccountType = document.getElementById('kyc_bank_account_type').value;
          const bankHolderName = document.getElementById('kyc_bank_holder_name').value.trim();

          if (!bankAccount || !bankIfsc || !bankName || !bankBranch || !bankAccountType || !bankHolderName) {
            errorMsg = 'Please fill in all bank details fields';
            isValid = false;
          } else if (!/^[A-Z]{4}0[A-Z0-9]{6}$/.test(bankIfsc.toUpperCase())) {
            errorMsg = 'Please enter a valid IFSC code (e.g., SBIN0001234)';
            isValid = false;
          } else if (bankAccount.length < 9 || bankAccount.length > 18) {
            errorMsg = 'Account number should be between 9 and 18 digits';
            isValid = false;
          }
          break;

        case 5: // e-KYC
          const mobile = document.getElementById('kyc_mobile').value.trim();
          const otpStatus = document.getElementById('kyc_otp_status').textContent;
          
          if (!mobile || !/^[6-9]\d{9}$/.test(mobile)) {
            errorMsg = 'Please enter a valid 10-digit mobile number';
            isValid = false;
          } else if (!otpStatus.includes('Verified successfully')) {
            errorMsg = 'Please complete OTP verification';
            isValid = false;
          }
          break;

        case 6: // Selfie
          if (!selfieData) {
            errorMsg = 'Please capture your selfie with face 75% visible and clear background';
            isValid = false;
          }
          break;

        case 7: // Review - always valid as it's just a summary
          break;
      }

      if (!isValid) {
        alert(errorMsg);
        // Highlight the problematic field
        highlightMissingFields(step);
      }

      return isValid;
    }

    function highlightMissingFields(step) {
      // Remove existing highlights
      document.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));
      
      // Add error styling
      const errorStyle = document.createElement('style');
      errorStyle.textContent = '.field-error { border-color: #ef4444 !important; background-color: #fef2f2 !important; }';
      document.head.appendChild(errorStyle);

      switch(step) {
        case 1:
          if (!document.getElementById('kyc_id_file').files[0]) {
            document.getElementById('kyc_id_file').classList.add('field-error');
          }
          break;
        case 2:
          if (!document.getElementById('kyc_addr_line').value.trim()) {
            document.getElementById('kyc_addr_line').classList.add('field-error');
          }
          if (!document.getElementById('kyc_city').value.trim()) {
            document.getElementById('kyc_city').classList.add('field-error');
          }
          if (!document.getElementById('kyc_addr_file').files[0]) {
            document.getElementById('kyc_addr_file').classList.add('field-error');
          }
          break;
        case 3:
          const incFileEl = document.getElementById('kyc_income_file');
          const incAmtEl = document.getElementById('kyc_income_amount');
          const bankStmtEl = document.getElementById('kyc_bank_stmt_file');
          const incTypeVal = (document.querySelector('input[name="kyc_income_type"]:checked')||{}).value || 'salaried';
          const incAmtVal = Number(incAmtEl.value || 0);

          if (incAmtVal <= 0) {
            incAmtEl.classList.add('field-error');
          }
          if (!incFileEl.files[0]) {
            incFileEl.classList.add('field-error');
          }
          if (incTypeVal === 'self' && incAmtVal > 0 && incAmtVal < 30000 && bankStmtEl && !bankStmtEl.files[0]) {
            bankStmtEl.classList.add('field-error');
          }
          break;
        case 4:
          ['kyc_bank_account', 'kyc_bank_ifsc', 'kyc_bank_name', 'kyc_bank_branch', 'kyc_bank_account_type', 'kyc_bank_holder_name'].forEach(id => {
            const el = document.getElementById(id);
            if (el && !el.value.trim()) {
              el.classList.add('field-error');
            }
          });
          break;
        case 5:
          if (!document.getElementById('kyc_mobile').value.trim() || !/^[6-9]\d{9}$/.test(document.getElementById('kyc_mobile').value.trim())) {
            document.getElementById('kyc_mobile').classList.add('field-error');
          }
          break;
      }
    }

    function sendManualEmail(data) {
      // Optional: Opens default email client if you want to manually send notification
      // This is completely optional and not required for KYC to work
      const subject = encodeURIComponent('KYC Submitted ‚Äì Review in Progress');
      const body = encodeURIComponent(`Hi there,\n\nYour KYC has been submitted successfully and is under review. This may take up to 1 hour.\n\nSummary (demo):\n${JSON.stringify(data, null, 2)}\n\nYou will get another notification once loan and EMI access is enabled.`);
      const adminEmail = 'anmol032906@gmail.com';
      const mailto = `mailto:${adminEmail}?subject=${subject}&body=${body}`;
      
      // Silently log instead of opening email client
      console.log('Manual email option available:', mailto);
    }

    function buildReview(){
      const d = collectKycData();
      const wrap = document.getElementById('kyc_review'); wrap.innerHTML = '';
      const addRow = (k,v) => wrap.insertAdjacentHTML('beforeend', `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #f1f5f9"><div class="muted">${k}</div><div style="font-weight:800">${v||'‚Äî'}</div></div>`);
      addRow('ID Type', d.id_type);
      addRow('ID File', d.id_file);
      addRow('Address', `${d.address_line || '‚Äî'}, ${d.city || ''}`);
      addRow('Address Proof', d.addr_file);
      addRow('Income Type', d.income_type);
      addRow('Income Amount (monthly)', d.income_amount);
      addRow('Income Proof', d.income_file);
      addRow('Bank Statement (6 months)', d.bank_stmt_file);
      addRow('Bank Account Number', d.bank_account);
      addRow('IFSC Code', d.bank_ifsc);
      addRow('Bank Name', d.bank_name);
      addRow('Branch', d.bank_branch);
      addRow('Account Type', d.bank_account_type);
      addRow('Account Holder Name', d.bank_holder_name);
      addRow('Mobile', d.mobile);
      addRow('OTP Status', d.otp_status);
      addRow('Selfie Verification', d.selfie_captured === 'Yes' ? '‚úÖ Captured' : '‚ùå Not captured');
      
      // Show selfie preview if available
      if(d.selfie_data) {
        wrap.insertAdjacentHTML('beforeend', `
          <div style="margin-top:16px;padding:12px;background:#f0fdf4;border:1.5px solid #86efac;border-radius:10px">
            <div style="font-weight:700;color:#166534;margin-bottom:8px">Selfie Preview</div>
            <img src="${d.selfie_data}" style="max-width:200px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1)" alt="Selfie preview">
          </div>
        `);
      }
    }

  })();
</script>

</body>
</html>

<!-- Admin Review Modal: list saved KYC entries and allow Approve (mailto), Export, Delete -->
<style>
  #adminModal{position:fixed;inset:0;background:rgba(8,15,20,0.45);display:none;align-items:center;justify-content:center;z-index:1300}
  #adminModal .panel{width:920px;max-width:94%;background:#fff;border-radius:12px;padding:18px;border:1px solid #e6edf3;box-shadow:0 20px 50px rgba(2,6,23,0.12)}
  #adminModal .list-item{padding:10px;border-radius:8px;border:1px solid #eef6f8;margin-bottom:8px;background:#fbfeff}
</style>

<div id="adminModal" role="dialog" aria-modal="true" style="display:none;align-items:center;justify-content:center">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h3 style="margin:0">Admin ‚Äî KYC Submissions</h3>
        <div class="muted" style="margin-top:6px">Review saved KYC submissions (demo). Approve sends an email via your mail client.</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="closeAdminReview()">Close</button>
        <button class="btn" onclick="exportAllKyc()">Export All</button>
      </div>
    </div>

    <div id="adminList" style="margin-top:12px;max-height:420px;overflow:auto"></div>
  </div>
</div>

<script>
  // Admin modal script
  const ADMIN_EMAIL = 'anmol032906@gmail.com'; // configured admin recipient

  window.openAdminReview = function(){
    document.getElementById('adminModal').style.display = 'flex';
    renderAdminList();
  };
  window.closeAdminReview = function(){ document.getElementById('adminModal').style.display = 'none'; };

  function listKycKeys(){
    const keys = [];
    try{
      // prefer explicit index if present
      const idx = JSON.parse(localStorage.getItem('kyc_index') || 'null');
      if(Array.isArray(idx) && idx.length) return idx.slice().reverse();
    }catch(e){}
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if(k && (k.startsWith('kyc_saved_') || k === 'kyc_data')) keys.push(k);
    }
    return keys.sort().reverse();
  }

  function renderAdminList(){
    const wrap = document.getElementById('adminList'); wrap.innerHTML = '';
    const keys = listKycKeys();
    if(keys.length === 0){ wrap.innerHTML = '<div class="muted">No KYC submissions found.</div>'; return; }
    keys.forEach(k => {
      let d = null;
      try{ d = JSON.parse(localStorage.getItem(k)); }catch(e){}
      const item = document.createElement('div'); item.className='list-item';
      const idLine = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">${k}</div><div class="small">${d && d.mobile? d.mobile : ''}</div></div>`;
      const summary = `<div class="muted" style="margin-top:6px">ID: ${d && d.id_type? d.id_type : '‚Äî'} ‚Ä¢ Address: ${d && (d.address_line||d.city) ? (d.address_line||'') + ' ' + (d.city||'') : '‚Äî'}</div>`;
      const actions = `<div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="approveKyc('${k}')">Approve ‚Üí</button>
          <button class="btn" onclick="exportKyc('${k}')">Export</button>
          <button class="btn" onclick="deleteKyc('${k}')">Delete</button>
        </div>`;
      item.innerHTML = idLine + summary + actions;
      wrap.appendChild(item);
    });
  }

  function approveKyc(key){
    const data = JSON.parse(localStorage.getItem(key) || '{}');
    // attempt server-side approve
    fetch('http://127.0.0.1:3000/api/admin/approve', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id: key, adminNote: 'Approved via admin UI'})})
      .then(r => r.json())
      .then(j => {
        if(j && j.ok){
          alert('Approved ‚Äî confirmation email sent by server.');
          try{ setKycStatus('verified', {approvedAt: Date.now(), adminNote:'Approved via server'}); showToast('KYC verified ‚Äî access enabled.', 'success'); ensureSystemCreditProfile(); }catch(_){ }
        } else {
          throw new Error('server failed');
        }
      }).catch(()=>{
        // fallback: open mail client for manual send
        try{ localStorage.setItem(key + '_status','approved'); }catch(e){}
        const subject = encodeURIComponent('KYC Verified ‚Äì Loan & EMI Access Enabled');
        const body = encodeURIComponent('Hi, your KYC is verified. Loan and EMI access is now enabled.\n\nReference: ' + (data.id_type || key) + '\nDetails:\n' + JSON.stringify(data, null, 2));
        const mailto = `mailto:${ADMIN_EMAIL}?subject=${subject}&body=${body}`;
        window.location.href = mailto;
        try{ setKycStatus('verified', {approvedAt: Date.now(), adminNote:'Approved manually'}); showToast('KYC verified ‚Äî access enabled.', 'success'); ensureSystemCreditProfile(); }catch(_){ }
      }).finally(()=> renderAdminList());
  }

  function exportKyc(key){
    const data = localStorage.getItem(key) || '{}';
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download = key + '.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function exportAllKyc(){
    const keys = listKycKeys(); const all = {};
    keys.forEach(k=>{ try{ all[k] = JSON.parse(localStorage.getItem(k)); }catch(e){ all[k] = localStorage.getItem(k); } });
    const blob = new Blob([JSON.stringify(all,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='kyc_all.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function deleteKyc(key){ if(!confirm('Delete ' + key + '?')) return; localStorage.removeItem(key); // also remove status
    localStorage.removeItem(key + '_status');
    // update index if present
    try{ const idx = JSON.parse(localStorage.getItem('kyc_index')||'[]'); const ni = idx.filter(i=>i!==key); localStorage.setItem('kyc_index', JSON.stringify(ni)); }catch(e){}
    try{ setKycStatus('not_started', {}); showToast('KYC reset. Submit again to unlock.', 'warn'); }catch(_){ }
    renderAdminList(); }
</script>
